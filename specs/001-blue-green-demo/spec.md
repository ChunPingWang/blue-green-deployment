# 功能規格書：藍綠佈署展示系統

**功能分支**: `001-blue-green-demo`
**建立日期**: 2025-12-04
**狀態**: 草稿
**輸入**: 使用者描述: "這個 codebase 有三個微服務的 monorepo，用來展示藍綠佈署。一個微服務為 Spring Cloud Gateway，第二個微服務為 blue-service 提供一個 API greeting 呼叫後回傳 Greeting from Blue Service，第三個微服務為 green-service 提供一個 API greeting 呼叫後回傳 Greeting from Green Service。Spring Cloud Gateway 分流 20% 到 blue-service 分流 80% 到 green-service"

## 使用者情境與測試 *(必填)*

### 使用者故事 1 - 透過閘道呼叫問候服務 (優先級: P1)

作為一個 API 使用者，我希望能夠透過統一的閘道端點呼叫問候服務，系統會根據預設的流量分配比例將我的請求導向藍色服務或綠色服務，讓我能夠體驗藍綠佈署的流量切換機制。

**優先級原因**: 這是系統的核心功能，展示藍綠佈署的基本運作原理。沒有這個功能，整個展示系統就沒有意義。

**獨立測試**: 可透過對閘道發送多次 greeting 請求，驗證回應分別來自藍色服務和綠色服務，並確認流量分配符合預期比例。

**驗收情境**:

1. **假設** 所有三個微服務都已啟動且運作正常，**當** 使用者對閘道的 greeting 端點發送請求，**則** 系統回傳 "Greeting from Blue Service" 或 "Greeting from Green Service"
2. **假設** 所有三個微服務都已啟動，**當** 使用者對閘道發送 100 次 greeting 請求，**則** 約有 20 次回傳來自藍色服務，約有 80 次回傳來自綠色服務（允許 ±5% 的誤差）

---

### 使用者故事 2 - 直接存取藍色服務 (優先級: P2)

作為一個開發人員，我希望能夠直接存取藍色服務的 greeting API，以便在不經過閘道的情況下測試和驗證藍色服務的功能。

**優先級原因**: 直接存取後端服務對於開發和除錯非常重要，但這不是展示藍綠佈署的主要功能。

**獨立測試**: 可透過直接對藍色服務端點發送請求，驗證回應內容正確。

**驗收情境**:

1. **假設** 藍色服務已啟動，**當** 使用者直接對藍色服務的 greeting 端點發送請求，**則** 系統回傳 "Greeting from Blue Service"

---

### 使用者故事 3 - 直接存取綠色服務 (優先級: P3)

作為一個開發人員，我希望能夠直接存取綠色服務的 greeting API，以便在不經過閘道的情況下測試和驗證綠色服務的功能。

**優先級原因**: 與藍色服務相同，直接存取對於開發和除錯很重要，但優先級較低因為綠色服務是主要流量目標，通常會透過閘道測試。

**獨立測試**: 可透過直接對綠色服務端點發送請求，驗證回應內容正確。

**驗收情境**:

1. **假設** 綠色服務已啟動，**當** 使用者直接對綠色服務的 greeting 端點發送請求，**則** 系統回傳 "Greeting from Green Service"

---

### 邊界案例

- 當藍色服務無法使用時，閘道應如何處理原本要導向藍色服務的請求？（假設：回傳錯誤訊息，不自動轉移流量）
- 當綠色服務無法使用時，閘道應如何處理原本要導向綠色服務的請求？（假設：回傳錯誤訊息，不自動轉移流量）
- 當閘道本身發生問題時，使用者應收到明確的錯誤回應
- 當請求格式不正確時，系統應回傳適當的錯誤訊息

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須提供一個 API 閘道作為所有外部請求的統一入口
- **FR-002**: 閘道必須將接收到的 greeting 請求依據權重分流至後端服務（20% 藍色服務，80% 綠色服務）
- **FR-003**: 藍色服務必須提供 greeting API 端點，回傳固定文字 "Greeting from Blue Service"
- **FR-004**: 綠色服務必須提供 greeting API 端點，回傳固定文字 "Greeting from Green Service"
- **FR-005**: 每個微服務必須能夠獨立啟動和運作
- **FR-006**: 系統必須支援健康檢查機制，讓閘道能夠確認後端服務的可用性
- **FR-007**: 當後端服務不可用時，系統必須回傳清楚的錯誤訊息

### 關鍵實體

- **閘道 (Gateway)**: 負責接收所有外部請求並根據設定的權重規則將流量分配到後端服務。主要屬性包含路由規則和權重設定。
- **藍色服務 (Blue Service)**: 提供問候功能的後端服務，代表藍綠佈署中的「藍色」版本。回傳特定的識別訊息。
- **綠色服務 (Green Service)**: 提供問候功能的後端服務，代表藍綠佈署中的「綠色」版本。回傳特定的識別訊息。

## 成功標準 *(必填)*

### 可衡量的成果

- **SC-001**: 透過閘道呼叫 greeting 服務的成功率達到 99.9%（在所有後端服務正常運作的情況下）
- **SC-002**: 在 1000 次請求的樣本中，流量分配比例與設定值（20%/80%）的誤差不超過 5%
- **SC-003**: 單一請求的回應時間不超過 1 秒（從發送請求到收到回應）
- **SC-004**: 所有三個微服務都能在 30 秒內完成啟動並準備好接受請求
- **SC-005**: 系統能夠清楚展示藍綠佈署的概念，讓觀看展示的人在 5 分鐘內理解流量分配的運作方式

## 假設

- 此系統為展示用途，不需要考慮高可用性或故障轉移機制
- 不需要身份驗證或授權機制
- 流量分配比例為固定值，不需要動態調整功能
- 所有服務運行在同一網路環境中
- 不需要持久化儲存任何資料
