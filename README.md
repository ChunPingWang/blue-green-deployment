# è—ç¶ éƒ¨ç½²å±•ç¤ºå°ˆæ¡ˆ (Blue-Green Deployment Demo)

> **åˆ†æ”¯èªªæ˜**
>
> | åˆ†æ”¯ | èªªæ˜ |
> |------|------|
> | `main` | ä¸»åˆ†æ”¯ï¼ŒåŒ…å«æœ¬æ©Ÿé–‹ç™¼ç‰ˆæœ¬çš„è—ç¶ éƒ¨ç½²å¯¦ä½œ |
> | `deploy-on-k8s` | Kubernetes éƒ¨ç½²ç‰ˆæœ¬ï¼ŒåŒ…å«å®Œæ•´çš„ K8s é…ç½®æª”èˆ‡éƒ¨ç½²æ•™å­¸ âœ… (ç›®å‰åˆ†æ”¯) |
>
> å¦‚éœ€æœ¬æ©Ÿé–‹ç™¼ç‰ˆæœ¬ï¼Œè«‹åˆ‡æ›è‡³ `main` åˆ†æ”¯ï¼š
> ```bash
> git checkout main
> ```

---

## é€™å€‹å°ˆæ¡ˆæ˜¯ä»€éº¼ï¼Ÿ

æƒ³åƒä½ ç¶“ç‡Ÿä¸€å®¶ç¶²è·¯å•†åº—ï¼Œæ¯å¤©éƒ½æœ‰æˆåƒä¸Šè¬çš„é¡§å®¢åœ¨ä½¿ç”¨ã€‚æœ‰ä¸€å¤©ï¼Œä½ éœ€è¦æ›´æ–°ç¶²ç«™çš„åŠŸèƒ½ï¼Œä½†ä½ ä¸æƒ³è®“é¡§å®¢çœ‹åˆ°ã€Œç³»çµ±ç¶­è­·ä¸­ã€çš„ç•«é¢ã€‚æ€éº¼è¾¦å‘¢ï¼Ÿ

**è—ç¶ éƒ¨ç½²**å°±æ˜¯è§£æ±ºé€™å€‹å•é¡Œçš„æ–¹æ³•ï¼

ç°¡å–®ä¾†èªªï¼š
- **è—è‰²ç‰ˆæœ¬ (Blue)**ï¼šç›®å‰æ­£åœ¨é‹è¡Œçš„èˆŠç‰ˆæœ¬
- **ç¶ è‰²ç‰ˆæœ¬ (Green)**ï¼šæº–å‚™ä¸Šç·šçš„æ–°ç‰ˆæœ¬

ä½ å¯ä»¥åŒæ™‚é‹è¡Œå…©å€‹ç‰ˆæœ¬ï¼Œç„¶å¾Œåƒåˆ‡æ›é–‹é—œä¸€æ¨£ï¼Œç¬é–“æŠŠæ‰€æœ‰æµé‡å¾è—è‰²åˆ‡æ›åˆ°ç¶ è‰²ã€‚å¦‚æœæ–°ç‰ˆæœ¬æœ‰å•é¡Œï¼Ÿæ²’é—œä¿‚ï¼Œå†åˆ‡å›è—è‰²å°±å¥½ï¼

---

## ç›®éŒ„

- [ä»€éº¼æ˜¯è—ç¶ éƒ¨ç½²ï¼Ÿ](#ä»€éº¼æ˜¯è—ç¶ éƒ¨ç½²)
- [å°ˆæ¡ˆæ¶æ§‹èªªæ˜](#å°ˆæ¡ˆæ¶æ§‹èªªæ˜)
- [ç’°å¢ƒéœ€æ±‚](#ç’°å¢ƒéœ€æ±‚)
- [å¿«é€Ÿé–‹å§‹ï¼ˆæœ¬æ©Ÿç‰ˆï¼‰](#å¿«é€Ÿé–‹å§‹æœ¬æ©Ÿç‰ˆ)
- [Kubernetes éƒ¨ç½²æ•™å­¸](#kubernetes-éƒ¨ç½²æ•™å­¸)
- [è—ç¶ åˆ‡æ›æ“ä½œæŒ‡å—](#è—ç¶ åˆ‡æ›æ“ä½œæŒ‡å—)
- [å°ˆæ¡ˆçµæ§‹](#å°ˆæ¡ˆçµæ§‹)
- [å¸¸è¦‹å•é¡Œ](#å¸¸è¦‹å•é¡Œ)

---

## ä»€éº¼æ˜¯è—ç¶ éƒ¨ç½²ï¼Ÿ

### ç”¨ç”Ÿæ´»ä¾‹å­ä¾†è§£é‡‹

æƒ³åƒä½ æ˜¯ä¸€å€‹é¤å»³è€é—†ï¼š

1. **å‚³çµ±åšæ³•**ï¼šé—œé–‰é¤å»³ â†’ è£ä¿® â†’ é‡æ–°é–‹å¼µ
   - ç¼ºé»ï¼šå®¢äººåƒä¸åˆ°é£¯ï¼Œä½ æœƒæå¤±æ”¶å…¥

2. **è—ç¶ éƒ¨ç½²**ï¼šåœ¨éš”å£é–‹ä¸€é–“æ–°é¤å»³ï¼ˆè£ä¿®å¥½ï¼‰â†’ æŠŠæ‹›ç‰Œç§»éå»
   - å„ªé»ï¼šå®¢äººå®Œå…¨ä¸å—å½±éŸ¿ï¼Œéš¨æ™‚å¯ä»¥åˆ‡æ›

### æŠ€è¡“ä¸Šçš„æµç¨‹

```
            å¹³æ™‚çš„ç‹€æ…‹
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  é¡§å®¢ â”€â”€â”€â–¶â”‚   è—è‰²ç‰ˆæœ¬ âœ“    â”‚ (æ­£åœ¨æœå‹™)
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   ç¶ è‰²ç‰ˆæœ¬      â”‚ (å¾…å‘½ä¸­)
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

            åˆ‡æ›å¾Œçš„ç‹€æ…‹
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   è—è‰²ç‰ˆæœ¬      â”‚ (å¾…å‘½ä¸­)
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  é¡§å®¢ â”€â”€â”€â–¶â”‚   ç¶ è‰²ç‰ˆæœ¬ âœ“    â”‚ (æ­£åœ¨æœå‹™)
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è—ç¶ éƒ¨ç½²çš„å„ªé»

| å„ªé» | èªªæ˜ |
|------|------|
| **é›¶åœæ©Ÿæ™‚é–“** | åˆ‡æ›ç¬é–“å®Œæˆï¼Œä½¿ç”¨è€…å®Œå…¨ç„¡æ„Ÿ |
| **å¿«é€Ÿå›æ»¾** | ç™¼ç¾å•é¡Œï¼Ÿåˆ‡å›å»åªéœ€å¹¾ç§’é˜ |
| **å®‰å…¨æ¸¬è©¦** | æ–°ç‰ˆæœ¬å¯ä»¥å…ˆå°ç¯„åœæ¸¬è©¦ |
| **æ¸›å°‘é¢¨éšª** | èˆŠç‰ˆæœ¬éš¨æ™‚å¾…å‘½ç•¶å‚™èƒ |

---

## å°ˆæ¡ˆæ¶æ§‹èªªæ˜

### å…ƒä»¶ä»‹ç´¹

é€™å€‹å°ˆæ¡ˆæœ‰ä¸‰å€‹ä¸»è¦å…ƒä»¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä½¿ç”¨è€… (ä½ )                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ ç™¼é€è«‹æ±‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ingress Controller                        â”‚
â”‚                    (äº¤é€šè­¦å¯Ÿ)                                 â”‚
â”‚         è² è²¬æŠŠå¤–éƒ¨æµé‡å°å…¥ Kubernetes å¢é›†                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Spring Cloud Gateway                        â”‚
â”‚                     (è·¯ç”±å™¨)                                  â”‚
â”‚              æ±ºå®šè¦æŠŠè«‹æ±‚é€çµ¦è—è‰²é‚„æ˜¯ç¶ è‰²                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                             â”‚
               â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Blue Service        â”‚   â”‚     Green Service        â”‚
â”‚        (è—è‰²ç‰ˆæœ¬)         â”‚   â”‚       (ç¶ è‰²ç‰ˆæœ¬)         â”‚
â”‚      å›æ‡‰: "æˆ‘æ˜¯è—è‰²"     â”‚   â”‚     å›æ‡‰: "æˆ‘æ˜¯ç¶ è‰²"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Kubernetes å‘½åç©ºé–“è¦åŠƒ

æˆ‘å€‘æŠŠä¸åŒçš„å…ƒä»¶æ”¾åœ¨ä¸åŒçš„ã€Œæˆ¿é–“ã€ï¼ˆNamespaceï¼‰è£¡ï¼Œæ–¹ä¾¿ç®¡ç†ï¼š

| Namespace | ç”¨é€” | è£¡é¢æœ‰ä»€éº¼ |
|-----------|------|-----------|
| `ingress-nginx` | å…¥å£æ§åˆ¶ | Nginx Ingress Controller |
| `gateway` | è·¯ç”±æ§åˆ¶ | Spring Cloud Gateway |
| `blue` | è—è‰²ç’°å¢ƒ | Blue Service |
| `green` | ç¶ è‰²ç’°å¢ƒ | Green Service |

### æµé‡è·¯å¾‘åœ–

```mermaid
flowchart TB
    subgraph Internet["ç¶²éš›ç¶²è·¯"]
        User["ä½¿ç”¨è€…"]
    end

    subgraph K8s["Kubernetes å¢é›†"]
        subgraph Ingress["ingress-nginx å‘½åç©ºé–“"]
            IC["Ingress Controller<br/>(å…¥å£)"]
        end

        subgraph GW["gateway å‘½åç©ºé–“"]
            Gateway["Spring Cloud Gateway<br/>(è·¯ç”±æ±ºç­–)"]
        end

        subgraph Blue["blue å‘½åç©ºé–“"]
            BlueService["Blue Service<br/>è—è‰²ç‰ˆæœ¬"]
        end

        subgraph Green["green å‘½åç©ºé–“"]
            GreenService["Green Service<br/>ç¶ è‰²ç‰ˆæœ¬"]
        end
    end

    User --> IC
    IC --> Gateway
    Gateway -->|"æ¬Šé‡è¨­å®š"| BlueService
    Gateway -->|"æ¬Šé‡è¨­å®š"| GreenService

    style BlueService fill:#66b3ff
    style GreenService fill:#90EE90
    style Gateway fill:#f9f
```

---

## ç’°å¢ƒéœ€æ±‚

### å¿…å‚™å·¥å…·

åœ¨é–‹å§‹ä¹‹å‰ï¼Œè«‹ç¢ºèªä½ çš„é›»è…¦å·²å®‰è£ä»¥ä¸‹å·¥å…·ï¼š

| å·¥å…· | ç”¨é€” | å®‰è£æª¢æŸ¥ |
|------|------|---------|
| **Docker** | å®¹å™¨åŒ–å¹³å° | `docker --version` |
| **Kind** | æœ¬æ©Ÿ K8s å¢é›† | `kind --version` |
| **kubectl** | K8s æŒ‡ä»¤å·¥å…· | `kubectl version` |
| **Java 17+** | åŸ·è¡Œ Spring Boot | `java -version` |

### ä»€éº¼æ˜¯é€™äº›å·¥å…·ï¼Ÿ

- **Docker**ï¼šæŠŠç¨‹å¼ã€Œæ‰“åŒ…ã€æˆä¸€å€‹ç®±å­ï¼ˆå®¹å™¨ï¼‰ï¼Œä¸ç®¡æ¬åˆ°å“ªå°é›»è…¦éƒ½èƒ½è·‘
- **Kind**ï¼šåœ¨ä½ çš„é›»è…¦ä¸Šå»ºç«‹ä¸€å€‹è¿·ä½ ç‰ˆçš„ Kubernetes
- **kubectl**ï¼šç”¨ä¾†æ§åˆ¶ Kubernetes çš„é™æ§å™¨
- **Java**ï¼šé€™å€‹å°ˆæ¡ˆç”¨ Java å¯«çš„ï¼Œéœ€è¦ Java ä¾†åŸ·è¡Œ

---

## å¿«é€Ÿé–‹å§‹ï¼ˆæœ¬æ©Ÿç‰ˆï¼‰

å¦‚æœä½ åªæƒ³åœ¨æœ¬æ©Ÿæ¸¬è©¦ï¼Œä¸éœ€è¦ Kubernetesï¼š

### æ­¥é©Ÿ 1ï¼šå•Ÿå‹•æœå‹™

é–‹å•Ÿä¸‰å€‹çµ‚ç«¯æ©Ÿè¦–çª—ï¼Œåˆ†åˆ¥åŸ·è¡Œï¼š

```bash
# çµ‚ç«¯æ©Ÿ 1 - Blue Service
cd blue-service
./gradlew bootRun

# çµ‚ç«¯æ©Ÿ 2 - Green Service
cd green-service
./gradlew bootRun

# çµ‚ç«¯æ©Ÿ 3 - Gateway
cd spring-cloud-gateway
./gradlew bootRun
```

### æ­¥é©Ÿ 2ï¼šæ¸¬è©¦

```bash
# ç›´æ¥æ¸¬è©¦è—è‰²æœå‹™
curl http://localhost:8081/greeting
# å›æ‡‰: Greeting from Blue Service

# ç›´æ¥æ¸¬è©¦ç¶ è‰²æœå‹™
curl http://localhost:8082/greeting
# å›æ‡‰: Greeting from Green Service

# é€é Gateway æ¸¬è©¦ï¼ˆæœƒæ ¹æ“šæ¬Šé‡åˆ†é…ï¼‰
curl http://localhost:8080/greeting
# å›æ‡‰: å¯èƒ½æ˜¯è—è‰²æˆ–ç¶ è‰²
```

---

## Kubernetes éƒ¨ç½²æ•™å­¸

### ç¬¬ä¸€æ­¥ï¼šå»ºç«‹ Kind å¢é›†

Kind æœƒåœ¨ä½ çš„é›»è…¦ä¸Šå»ºç«‹ä¸€å€‹è¿·ä½  Kubernetesï¼š

```bash
# å»ºç«‹å¢é›†ï¼ˆä½¿ç”¨æˆ‘å€‘æº–å‚™å¥½çš„è¨­å®šæª”ï¼‰
kind create cluster --config k8s/kind-config.yaml

# ç¢ºèªå¢é›†å»ºç«‹æˆåŠŸ
kubectl cluster-info --context kind-blue-green-demo
```

**æˆåŠŸç•«é¢ï¼š**
```
Kubernetes control plane is running at https://127.0.0.1:xxxxx
CoreDNS is running at https://127.0.0.1:xxxxx/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
```

### ç¬¬äºŒæ­¥ï¼šå»ºç«‹å‘½åç©ºé–“

å‘½åç©ºé–“å°±åƒæ˜¯ä¸åŒçš„æˆ¿é–“ï¼ŒæŠŠç›¸é—œçš„æ±è¥¿æ”¾åœ¨ä¸€èµ·ï¼š

```bash
kubectl apply -f k8s/namespaces.yaml
```

**é©—è­‰ï¼š**
```bash
kubectl get namespaces
# æ‡‰è©²çœ‹åˆ°: blue, green, gateway, ingress
```

### ç¬¬ä¸‰æ­¥ï¼šå®‰è£ Ingress Controller

Ingress Controller æ˜¯å¢é›†çš„ã€Œå¤§é–€ã€ï¼š

```bash
kubectl apply -f k8s/ingress/nginx-ingress.yaml

# ç­‰å¾…å®‰è£å®Œæˆï¼ˆç´„ 1-2 åˆ†é˜ï¼‰
kubectl wait --namespace ingress-nginx \
  --for=condition=ready pod \
  --selector=app.kubernetes.io/component=controller \
  --timeout=120s
```

### ç¬¬å››æ­¥ï¼šå»ºç«‹ Docker æ˜ åƒæª”

æŠŠæˆ‘å€‘çš„ç¨‹å¼æ‰“åŒ…æˆå®¹å™¨ï¼š

```bash
# å»ºç«‹è—è‰²æœå‹™æ˜ åƒæª”
docker build -t blue-service:latest -f blue-service/Dockerfile .

# å»ºç«‹ç¶ è‰²æœå‹™æ˜ åƒæª”
docker build -t green-service:latest -f green-service/Dockerfile .

# å»ºç«‹ Gateway æ˜ åƒæª”
docker build -t api-gateway:latest -f spring-cloud-gateway/Dockerfile .
```

**å°çŸ¥è­˜ï¼š** é€™å€‹æ­¥é©Ÿå¯èƒ½éœ€è¦ 5-10 åˆ†é˜ï¼Œå› ç‚ºè¦ä¸‹è¼‰ Java ç’°å¢ƒ

### ç¬¬äº”æ­¥ï¼šè¼‰å…¥æ˜ åƒæª”åˆ° Kind

Kind å¢é›†éœ€è¦ã€Œçœ‹å¾—åˆ°ã€æˆ‘å€‘çš„æ˜ åƒæª”ï¼š

```bash
kind load docker-image blue-service:latest --name blue-green-demo
kind load docker-image green-service:latest --name blue-green-demo
kind load docker-image api-gateway:latest --name blue-green-demo
```

### ç¬¬å…­æ­¥ï¼šéƒ¨ç½²æ‰€æœ‰æœå‹™

```bash
# éƒ¨ç½²è—è‰²æœå‹™
kubectl apply -f k8s/blue/

# éƒ¨ç½²ç¶ è‰²æœå‹™
kubectl apply -f k8s/green/

# éƒ¨ç½² Gateway
kubectl apply -f k8s/gateway/
```

### ç¬¬ä¸ƒæ­¥ï¼šç¢ºèªéƒ¨ç½²æˆåŠŸ

```bash
# æŸ¥çœ‹æ‰€æœ‰ Pod ç‹€æ…‹
kubectl get pods -A | grep -E "blue|green|gateway"
```

**æˆåŠŸç•«é¢ï¼š**
```
blue      blue-service-xxx    1/1     Running   0          1m
green     green-service-xxx   1/1     Running   0          1m
gateway   api-gateway-xxx     1/1     Running   0          1m
```

### ç¬¬å…«æ­¥ï¼šæ¸¬è©¦

```bash
# å¾å¢é›†å…§éƒ¨æ¸¬è©¦
kubectl run test --rm -i --restart=Never --image=curlimages/curl \
  -- curl -s http://api-gateway.gateway.svc.cluster.local:8080/greeting
```

---

## è—ç¶ åˆ‡æ›æ“ä½œæŒ‡å—

é€™æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼å­¸æœƒé€™å€‹ï¼Œä½ å°±å­¸æœƒè—ç¶ éƒ¨ç½²äº†ï¼

### æŸ¥çœ‹ç›®å‰çš„æµé‡è¨­å®š

```bash
kubectl get configmap gateway-config -n gateway -o yaml
```

æ‰¾åˆ° `Weight` çš„è¨­å®šï¼š
- `Weight=greeting-group, 10` è¡¨ç¤ºæ¬Šé‡æ˜¯ 10
- æ•¸å­—è¶Šå¤§ï¼Œåˆ†é…åˆ°çš„æµé‡è¶Šå¤š

### åˆ‡æ›åˆ° 100% è—è‰²

ç·¨è¼¯ `k8s/gateway/configmap.yaml`ï¼š

```yaml
# è—è‰²æ¬Šé‡è¨­ç‚º 10ï¼Œç¶ è‰²è¨­ç‚º 0
- id: blue-service
  uri: http://blue-service.blue.svc.cluster.local:8081
  predicates:
    - Path=/greeting
    - Weight=greeting-group, 10    # â† æ”¹æˆ 10

- id: green-service
  uri: http://green-service.green.svc.cluster.local:8082
  predicates:
    - Path=/greeting
    - Weight=greeting-group, 0     # â† æ”¹æˆ 0
```

å¥—ç”¨è®Šæ›´ï¼š
```bash
kubectl apply -f k8s/gateway/configmap.yaml
kubectl rollout restart deployment/api-gateway -n gateway
```

### åˆ‡æ›åˆ° 100% ç¶ è‰²

```yaml
# è—è‰²æ¬Šé‡è¨­ç‚º 0ï¼Œç¶ è‰²è¨­ç‚º 10
- Weight=greeting-group, 0     # è—è‰²
- Weight=greeting-group, 10    # ç¶ è‰²
```

### é‡‘çµ²é›€éƒ¨ç½²ï¼ˆCanaryï¼‰

æƒ³è¦å…ˆè®“ 20% çš„ä½¿ç”¨è€…è©¦ç”¨æ–°ç‰ˆæœ¬ï¼Ÿ

```yaml
# 80% è—è‰²ï¼Œ20% ç¶ è‰²
- Weight=greeting-group, 8     # è—è‰² 80%
- Weight=greeting-group, 2     # ç¶ è‰² 20%
```

### å¿«é€Ÿåƒè€ƒè¡¨

| æƒ…å¢ƒ | è—è‰²æ¬Šé‡ | ç¶ è‰²æ¬Šé‡ | èªªæ˜ |
|------|---------|---------|------|
| å…¨éƒ¨è—è‰² | 10 | 0 | 100% æµé‡åˆ°è—è‰² |
| å…¨éƒ¨ç¶ è‰² | 0 | 10 | 100% æµé‡åˆ°ç¶ è‰² |
| é‡‘çµ²é›€ 20% | 8 | 2 | 20% æµé‡æ¸¬è©¦æ–°ç‰ˆ |
| é‡‘çµ²é›€ 50% | 5 | 5 | å„åŠæµé‡ |

---

## å°ˆæ¡ˆçµæ§‹

```
blue-green-deployment/
â”‚
â”œâ”€â”€ ğŸ“ k8s/                          # Kubernetes è¨­å®šæª”
â”‚   â”œâ”€â”€ kind-config.yaml            # Kind å¢é›†è¨­å®š
â”‚   â”œâ”€â”€ namespaces.yaml             # å‘½åç©ºé–“å®šç¾©
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ ingress/                 # Ingress è¨­å®š
â”‚   â”‚   â””â”€â”€ nginx-ingress.yaml      # Nginx Ingress Controller
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ gateway/                 # Gateway è¨­å®š
â”‚   â”‚   â”œâ”€â”€ configmap.yaml          # â­ è—ç¶ åˆ‡æ›è¨­å®šæª”
â”‚   â”‚   â”œâ”€â”€ deployment.yaml         # Gateway éƒ¨ç½²è¨­å®š
â”‚   â”‚   â”œâ”€â”€ service.yaml            # Gateway æœå‹™è¨­å®š
â”‚   â”‚   â””â”€â”€ ingress.yaml            # å…¥å£è¨­å®š
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ blue/                    # è—è‰²æœå‹™è¨­å®š
â”‚   â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”‚   â””â”€â”€ service.yaml
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“ green/                   # ç¶ è‰²æœå‹™è¨­å®š
â”‚       â”œâ”€â”€ deployment.yaml
â”‚       â””â”€â”€ service.yaml
â”‚
â”œâ”€â”€ ğŸ“ blue-service/                 # è—è‰²æœå‹™ç¨‹å¼ç¢¼
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ build.gradle
â”‚   â””â”€â”€ Dockerfile
â”‚
â”œâ”€â”€ ğŸ“ green-service/                # ç¶ è‰²æœå‹™ç¨‹å¼ç¢¼
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ build.gradle
â”‚   â””â”€â”€ Dockerfile
â”‚
â”œâ”€â”€ ğŸ“ spring-cloud-gateway/         # Gateway ç¨‹å¼ç¢¼
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ build.gradle
â”‚   â””â”€â”€ Dockerfile
â”‚
â”œâ”€â”€ ğŸ“ scripts/                      # æ¸¬è©¦è…³æœ¬
â”‚   â””â”€â”€ test-traffic.sh
â”‚
â””â”€â”€ README.md                        # ä½ æ­£åœ¨çœ‹çš„é€™ä»½æ–‡ä»¶
```

---

## å¸¸è¦‹å•é¡Œ

### Q1: Pod ä¸€ç›´é¡¯ç¤º Pendingï¼Ÿ

**åŸå› **ï¼šè³‡æºä¸è¶³ï¼ˆCPU æˆ–è¨˜æ†¶é«”ï¼‰

**è§£æ±ºæ–¹æ³•**ï¼š
```bash
# æŸ¥çœ‹è©³ç´°åŸå› 
kubectl describe pod <pod-name> -n <namespace>

# å¦‚æœæ˜¯è³‡æºä¸è¶³ï¼Œå¯ä»¥èª¿æ•´ deployment.yaml ä¸­çš„ resources
```

### Q2: å¦‚ä½•å®Œå…¨åˆªé™¤å¢é›†é‡ä¾†ï¼Ÿ

```bash
# åˆªé™¤ Kind å¢é›†
kind delete cluster --name blue-green-demo

# é‡æ–°å»ºç«‹
kind create cluster --config k8s/kind-config.yaml
```

### Q3: å¦‚ä½•æŸ¥çœ‹ Gateway çš„æ—¥èªŒï¼Ÿ

```bash
kubectl logs -l app=api-gateway -n gateway --tail=50
```

### Q4: ç‚ºä»€éº¼ localhost ç„¡æ³•å­˜å–ï¼Ÿ

å¯èƒ½æ˜¯ port 80 è¢«å…¶ä»–ç¨‹å¼ä½”ç”¨ï¼ˆå¦‚ Rancher Desktopï¼‰ã€‚å¯ä»¥ä½¿ç”¨ port-forwardï¼š

```bash
kubectl port-forward svc/api-gateway -n gateway 8888:8080
# ç„¶å¾Œç”¨ http://localhost:8888/greeting æ¸¬è©¦
```

### Q5: å¦‚ä½•æª¢æŸ¥æœå‹™æ˜¯å¦æ­£å¸¸ï¼Ÿ

```bash
# æª¢æŸ¥ Pod ç‹€æ…‹
kubectl get pods -A

# æª¢æŸ¥ Service ç‹€æ…‹
kubectl get svc -A

# æª¢æŸ¥ Ingress ç‹€æ…‹
kubectl get ingress -A
```

---

## å»¶ä¼¸å­¸ç¿’

æƒ³è¦æ›´æ·±å…¥äº†è§£ï¼Ÿä»¥ä¸‹æ˜¯æ¨è–¦çš„å­¸ç¿’è³‡æºï¼š

1. **Kubernetes å®˜æ–¹æ•™å­¸**ï¼šhttps://kubernetes.io/docs/tutorials/
2. **Spring Cloud Gateway æ–‡ä»¶**ï¼šhttps://spring.io/projects/spring-cloud-gateway
3. **è—ç¶ éƒ¨ç½²æ¨¡å¼**ï¼šhttps://martinfowler.com/bliki/BlueGreenDeployment.html

---

## æˆæ¬Š

æœ¬å°ˆæ¡ˆåƒ…ä¾›å­¸ç¿’èˆ‡å±•ç¤ºç”¨é€”ã€‚

---

> ğŸ‰ æ­å–œä½ çœ‹å®Œäº†ï¼ç¾åœ¨ä½ å·²ç¶“äº†è§£è—ç¶ éƒ¨ç½²çš„æ¦‚å¿µå’Œå¯¦ä½œæ–¹å¼äº†ï¼
